<!DOCTYPE html>
<html>
<head>
    <title>üîç Debug localStorage - Najdi sv√© modifikace</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; background: #0a0a0a; }
        .found { color: #00ff00; }
        .empty { color: #ff6666; }
        .url { color: #66ccff; word-break: break-all; }
        pre { background: #222; padding: 10px; overflow-x: auto; }
        button { background: #333; color: #fff; border: none; padding: 10px; margin: 5px; cursor: pointer; }
        button:hover { background: #555; }
    </style>
</head>
<body>
    <h1>üîç HLED√ÅN√ç VA≈†ICH LOK√ÅLN√çCH DAT</h1>
    
    <div class="section">
        <h2>üìä Stav localStorage:</h2>
        <div id="localStorage-status"></div>
    </div>
    
    <div class="section">
        <h2>üéØ Nalezen√© obr√°zky k synchronizaci:</h2>
        <div id="found-images"></div>
    </div>
    
    <div class="section">
        <h2>üöÄ Akce:</h2>
        <button onclick="scanLocalStorage()">üîç Znovu prohledat localStorage</button>
        <button onclick="syncFound()">üì° Synchronizovat nalezen√©</button>
        <button onclick="clearEverything()">üóëÔ∏è Vyƒçistit localStorage</button>
        <button onclick="exportData()">üíæ Exportovat data</button>
    </div>
    
    <div class="section">
        <h2>üìù Log:</h2>
        <div id="log"></div>
    </div>

    <script>
        let foundData = [];
        
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function scanLocalStorage() {
            log('üîç Prohled√°v√°m localStorage...');
            foundData = [];
            
            // V≈°echny mo≈æn√© kl√≠ƒçe kde mohou b√Ωt data
            const keys = [
                'apply_model_state',
                'everart_generations', 
                'generations',
                'modelState',
                'userGenerations',
                'imageResults'
            ];
            
            let totalImages = 0;
            
            keys.forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data && data !== 'null' && data !== '[]' && data !== '{}') {
                        log(`‚úÖ Nalezen kl√≠ƒç: ${key} (${data.length} znak≈Ø)`);
                        
                        const parsed = JSON.parse(data);
                        
                        // Zpracuj apply_model_state
                        if (key === 'apply_model_state' && parsed.instances) {
                            parsed.instances.forEach((instance, idx) => {
                                if (instance.results && Array.isArray(instance.results)) {
                                    instance.results.forEach((result, resultIdx) => {
                                        if (result.resultUrl) {
                                            foundData.push({
                                                source: key,
                                                id: `${key}-${idx}-${resultIdx}`,
                                                outputImageUrl: result.resultUrl,
                                                inputImageUrl: result.originalUrl || '',
                                                modelId: instance.selectedModel?.everartId || 'nezn√°m√Ω'
                                            });
                                            totalImages++;
                                        }
                                    });
                                }
                            });
                        }
                        
                        // Zpracuj arrays s generacemi
                        if (Array.isArray(parsed)) {
                            parsed.forEach((item, idx) => {
                                if (item.outputImageUrl || item.resultUrl || item.image_url) {
                                    foundData.push({
                                        source: key,
                                        id: `${key}-${idx}`,
                                        outputImageUrl: item.outputImageUrl || item.resultUrl || item.image_url,
                                        inputImageUrl: item.inputImageUrl || '',
                                        modelId: item.modelId || 'nezn√°m√Ω'
                                    });
                                    totalImages++;
                                }
                            });
                        }
                    } else {
                        log(`‚ùå Kl√≠ƒç ${key}: pr√°zdn√Ω nebo neexistuj√≠c√≠`);
                    }
                } catch (e) {
                    log(`‚ö†Ô∏è Chyba p≈ôi zpracov√°n√≠ ${key}: ${e.message}`);
                }
            });
            
            log(`üéØ CELKEM NALEZENO: ${totalImages} obr√°zk≈Ø ve ${foundData.length} z√°znamech`);
            displayFound();
        }
        
        function displayFound() {
            const div = document.getElementById('found-images');
            
            if (foundData.length === 0) {
                div.innerHTML = '<div class="empty">‚ùå ≈Ω√°dn√© obr√°zky nenalezeny v localStorage</div>';
                return;
            }
            
            let html = `<div class="found">‚úÖ Nalezeno ${foundData.length} obr√°zk≈Ø:</div>`;
            
            foundData.forEach((item, idx) => {
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #444;">
                        <strong>${idx + 1}. ${item.source}</strong><br>
                        <div class="url">üì∏ ${item.outputImageUrl}</div>
                        <div>üîß Model: ${item.modelId}</div>
                    </div>
                `;
            });
            
            div.innerHTML = html;
        }
        
        async function syncFound() {
            if (foundData.length === 0) {
                log('‚ùå ≈Ω√°dn√° data k synchronizaci');
                return;
            }
            
            log(`üì° Spou≈°t√≠m synchronizaci ${foundData.length} obr√°zk≈Ø...`);
            
            try {
                const response = await fetch('/api/generations/sync-cloudinary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        localStorageData: foundData
                    })
                });
                
                const result = await response.json();
                
                log(`üéâ SYNCHRONIZACE DOKONƒåENA:`);
                log(`‚úÖ Synchronizov√°no: ${result.synced}`);
                log(`‚ùå Chyby: ${result.errors}`);
                log(`üìä Celkem: ${result.totalProcessed}`);
                log(`üìù ${result.message}`);
                
                if (result.detailedLog && result.detailedLog.length > 0) {
                    log('üìã Detailn√≠ log:');
                    result.detailedLog.forEach(logEntry => log(`  ${logEntry}`));
                }
                
            } catch (error) {
                log(`üí• Chyba p≈ôi synchronizaci: ${error.message}`);
            }
        }
        
        function clearEverything() {
            if (confirm('Opravdu chcete vymazat V≈†ECHNA localStorage data? Toto nelze vr√°tit zpƒõt!')) {
                localStorage.clear();
                log('üóëÔ∏è V≈°echna localStorage data vymaz√°na');
                scanLocalStorage();
            }
        }
        
        function exportData() {
            const allData = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `localStorage-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            log('üíæ Data exportov√°na do souboru');
        }
        
        // Automaticky spus≈• p≈ôi naƒçten√≠
        window.onload = function() {
            log('üöÄ Debug n√°stroj spu≈°tƒõn');
            scanLocalStorage();
        };
    </script>
</body>
</html>